# ATLAS GRID SIMULATION Documentation

This documentation is a placeholder for all the information and open questions regarding the atlas grid simulator

## 1. Simulator Overview

- **Simulator Purpose**: The simulator is designed to simulate jobs on ATLAS grid, with the goal of closely reproducing the current PANDA system behavior.


## 2. Simulator Input 
The simulator takes PANDA jobs as input, with an initial focus on modeling user jobs. Each job is characterized by a set of parameters, which, while not yet finalized, provide a foundational definition:

1. **Number of Input Files**: Specifies how many input files are associated with the job.
2. **Size of Input Files**: The total size of the input files for the job.
3. **Number of Output Files**: The number of output files generated by the job, typically two.
4. **Size of Output Files**: The total size of the output files produced.
5. **Number of FLOPs**: The computational workload required, represented by the number of floating-point operations (FLOPs).

## Job Injection Approach

- **Historical Data Injection**: Initially, historical user job data will be directly injected into the simulator.
  
- **Future Integration with AI Surrogate Model**: In later stages, Davidâ€™s AI surrogate model's will be integrated to provide the job data for the simulations. 
  
## 3. Brokerage Model 

The brokerage model is responsible for selecting the appropriate queues for jobs. Below is the simplified workflow of the brokerage model as presented by Paul [Paul Presentation](https://docs.google.com/presentation/d/1hgR4LRkscoVlz9rXHqekVPiY5GwYKj4kJvyz7JbMiFY/edit#slide=id.g30f43e9cb42_0_0).

### 3.1 Simplified Workflow of Brokerage Model

1. **Make Preliminary List**: Generate an initial list of candidate queues for job allocation.
2. **Apply Filters**: Apply predefined filters to refine the candidate list.
3. **Calculate Weights**: Calculate weights to rank the queues.
4. **Select Best Candidate**: Select the top-ranked queue as the final destination.

**Note**: This workflow is designed for production jobs. User jobs require an additional step and slight modifications to steps 1-3.

To perform these steps, the brokerage model utilizes data from various sources, outlined below.
### 3.2 Data Sources Used by the Brokerage Model

1. **PandA DB**: Contains the `gdpconfig` table with key parameters used by the brokerage algorithm. (Tania can help to extract these values; data updates every 10 minutes according to Tadasi)
2. **CRIC**: Provides queue parameters, excluding CPU information.
3. **Historical Task or Job Parameters**: Additional metadata related to task or job details.
4. **Rucio Metrics**: Includes network bandwidth and disk space metrics. Updated information is available in a JSON file (previously obtained via web scraping by paul). The frequency and process of file retrieval are yet to be clarified.

**Note**: The real brokerage algorithm consults the Rucio metrics JSON file every 10 minutes for updated data.

## 4. Error Modelling

- **Stages of Jobs**: Modeling job stages is critical, as the error modeling directly depends on the stage at which errors occur. The error codes and the diagnostic methods are dependent on the job stage.

## 5. Simulator Output Requirements and Metrics

### 5.1 Site-Level Metrics

- **Suggested Metrics**:
  - Number of jobs running
  - Number of cores engaged
  - Failure rates
  - CPU wastage due to job failures

### 5.2 Job-Level Metrics

- **Suggested Metrics**:
  - Job start time (difference between submitted time and actual start time)
  - Successful job completion time
  - Global Queue

## 6. Handling Remote Transfers

- **Pre-Execution Transfers**: If the required input files are not available at the computing site, a remote transfer is triggered to fetch these files before job execution.
- **Post-Execution Transfers**: After job completion, the output is stored locally but may need to be transferred to a designated remote nucleus, depending on the job's destination settings.

The simulator should be equipped to model these remote transfers accurately, ensuring remote transfers are tracked independently.

## 7. Simulator Validation Parameters
Need to identify the metrics which are not part of injected job that can be used to validate the simulator
- **Pilot-Reported Parameters**: Identify parameters measured by the pilot that could be used to validate simulator outputs.

## 9. Open Questions
- **Job Assignment Details**: Details on how jobs are assigned to sites or CPUs remain unclear.
- **Job Execution Stages**: Information on which fields are populated at each stage of job execution is essential for accurate simulation.

- **Calibration and Evaluation Strategy**: Begin with local calibration and extend to a global evaluation for better accuracy.

## 10. Misc:
- **Log Access and Analysis**: Logs on brokerage operations, such as queue selection reasoning, are available for a limited period (one week). (Tania can help)


**Contributors**:  

**Document History**:  
- Version 1.0 - Initial draft
